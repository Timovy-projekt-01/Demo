<?php

namespace App\Services\Malware;

use App\Services\HttpService;
use Illuminate\Support\Facades\Cache;

class Sparql
{
    private $httpService;

    public function __construct(HttpService $httpService)
    {
        $this->httpService = $httpService;
    }

    public function searchEntities(string $searchTerm)
    {
        $query = 'SELECT ?entity ?property ?value
                    WHERE {
                    ?entity ?property ?value .
                    FILTER (regex(?value, "^' . $searchTerm . '", "i")) .
                    FILTER (?property IN (
                        <http://stufei/ontologies/malware#hasName>,
                        <http://stufei/ontologies/malware#name>,
                        <http://stufei/ontologies/malware#hasSubmitName>
                    )) .
                    }
                    LIMIT 3';
        $result = $this->httpService->get($query);
        $parsedData = $this->parseValues($result);

        Cache::put('malware', $parsedData);
        return $parsedData;
    }

    public function getMalwareProperties($malwareId)
    {
        $query = 'SELECT ?property ?value WHERE {
                    <http://stufei/ontologies/malware#' . $malwareId . '> ?property ?value.
                    }';

        $response = $this->httpService->get($query);

        $result = $this->httpService->get($query);
        $parsedData = $this->parseValues($result);
        return $parsedData;
        /* dd($response, $malwareId);
        return collect($response['results']['bindings'])->map(function ($bind) {
            return (array)$bind;
        })->toArray(); */
    }

    private function parseValues($rawData)
    {
        //dump($rawData);
        $parsedData = array_map(function ($item) {
            if (isset($item['entity']['value'])) {
                $item['entity']['value'] = $this->extractValue($item['entity']['value']);
            }
            if (isset($item['property']['value'])) {
                $item['property']['value'] = $this->extractValue($item['property']['value']);
            }
            if (isset($item['value']['value'])) {
                $item['value']['value'] = $this->extractValue($item['value']['value']);
            }
            return $item;
        }, $rawData);
        return $parsedData;
    }
    private function extractValue($uri, $charToFind = '#')
    {
        if ($uri && strpos($uri, $charToFind) !== false) {
            $hashtagIndex = strrpos($uri, $charToFind);
            return substr($uri, $hashtagIndex + 1);
        }
        return $uri; // Return the entire URI if the character is not found
    }
}
