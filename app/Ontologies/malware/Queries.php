<?php

namespace App\Ontologies\Malware;

use App\Ontologies\Helpers\HttpService;
use Illuminate\Support\Facades\Cache;

class Queries
{
    private $httpService;

    public function __construct(HttpService $httpService)
    {
        $this->httpService = $httpService;
    }

    /**
     * Retrieves the names of entities based on their IDs.
     *
     * @param array $entityIds An array of entity IDs.
     * @return array An array of entity names.
     */
    public function getNames($entityIds)
    {
        $ids = implode(" ", array_map(function ($id) {
            return "<http://stufei/ontologies/malware#{$id}>";
        }, $entityIds));
        //dd($ids);
        $query = "SELECT ?entity ?name
              WHERE {
                  VALUES ?entity { {$ids} }
                  ?entity <http://stufei/ontologies/malware#hasName> ?name .
              }";

        $results = $this->httpService->get($query);

        $names = [];
        foreach ($results as $result) {
            $names[] = $result['name']['value'];
        }

        return $names;
    }
    /**
     * Searches for entities based on a given search term.
     *
     * @param string $searchTerm The search term to filter entities.
     * @return array The parsed data containing the entities, properties, and values.
     */
    public function searchEntities(string $searchTerm)
    {
        $query = 'SELECT ?entity ?property ?value
                    WHERE {
                    ?entity ?property ?value .
                    FILTER (regex(?value, "^' . $searchTerm . '", "i")) .
                    FILTER (?property IN (
                        <http://stufei/ontologies/malware#hasName>,
                        <http://stufei/ontologies/malware#name>,
                        <http://stufei/ontologies/malware#hasSubmitName>
                    )) .
                    }
                    LIMIT 3';
        $result = $this->httpService->get($query);
        $parsedData = $this->parseValues($result);

        return $parsedData;
    }

    /**
     * Retrieves the raw malware properties for a given entity ID.
     *
     * @param string $entityId The ID of the entity.
     * @return array The parsed data containing the properties and their values.
     */
    public function getRawMalwareProperties($entityId)
    {
        $query = 'SELECT ?property ?value WHERE {
                    <http://stufei/ontologies/malware#' . $entityId . '> ?property ?value.
                    }';

        $response = $this->httpService->get($query);

        $result = $this->httpService->get($query);
        $parsedData = $this->parseValues($result);
        return $parsedData;
    }

    /**
     * Parses the values in the given raw data array.
     *
     * @param array $rawData The raw data array to be parsed.
     * @return array The parsed data array.
     */
    private function parseValues($rawData)
    {
        //dump($rawData);
        $parsedData = array_map(function ($item) {
            if (isset($item['entity']['value'])) {
                $item['entity']['value'] = $this->extractValue($item['entity']['value']);
            }
            if (isset($item['property']['value'])) {
                $item['property']['value'] = $this->extractValue($item['property']['value']);
            }
            if (isset($item['value']['value'])) {
                $item['value']['value'] = $this->extractValue($item['value']['value']);
            }
            return $item;
        }, $rawData);
        return $parsedData;
    }

    /**
     * Extracts the value after the last occurrence of a character in a URI.
     *
     * @param string $uri The URI to extract the value from.
     * @param string $charToFind The character to search for in the URI. Default is '#'.
     * @return string The extracted value from the URI, or the entire URI if the character is not found.
     */
    private function extractValue($uri, $charToFind = '#')
    {
        if ($uri && strpos($uri, $charToFind) !== false) {
            $hashtagIndex = strrpos($uri, $charToFind);
            return substr($uri, $hashtagIndex + 1);
        }
        return $uri; // Return the entire URI if the character is not found
    }
}
